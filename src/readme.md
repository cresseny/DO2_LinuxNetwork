# Part 1

```sudo apt install ipcalc``` - для установки утилиты ipcalc

## 1.1

Адрес сети 192.167.38.54/13
![alt text](../src/png/1.png)

перевод маски 255.255.255.0 в префиксную и двоичную запись - netmask:
![alt text](../src/png/2.png)

перевод маски /15 в обычную и двоичную
![alt text](../src/png/3.png)

11111111.11111111.11111111.11110000 в обычную и префиксную
![alt text](../src/png/4.png)

Минимальный и максимальный хост в сети 12.167.38.4
HostMin и HostMax

При маске /8

![alt text](../src/png/5.png)

при маске 11111111.11111111.00000000.00000000
![alt text](../src/png/6.png)

при маске 12.167.38.4/255.255.254.0
![alt text](../src/png/7.png)

При маске /4
![alt text](../src/png/8.png)

## 1.2

![alt text](../src/png/9.png)

    94.34.23.100 - Нельзя обратиться
    127.0.0.2 - Можно обратиться
    127.1.0.1 - Можно обратиться
    128.0.0.1 - Нельзя обратиться

## 1.3

    10.0.0.45 - частный
    134.43.0.2 - публичный
    192.168.4.2 - частный
    172.20.250.4 - частный
    172.0.2.1 - публичный
    192.172.0.1 - публичный
    172.68.0.2 - публичный
    172.16.255.255 - частный
    10.10.10.10 - частный
    192.169.168.1 - публичный

IP перечисленных адресов шлюза возможны у сети 10.10.0.0/18:
![alt text](../src/png/10.png)

    10.0.0.1 - нет
    10.10.0.2 - да
    10.10.10.10 - да
    10.10.100.1 - нет
    10.10.1.255 - да

# Part 2

## 2.1

две виртуальные машины ws1 и ws2

![alt text](../src/png/11.png)

вывоод команды ip a на машинах

![alt text](../src/png/12.png)

в настройках машин изменил тип соеденения на локалку

задал адреса и маски для двух машин
![alt text](../src/png/13.png)

## 2.2

связалы машины между собой и пропинговал

![alt text](../src/png/14.png)

внес измененияи, соеденение осалось

![alt text](../src/png/15.png)

# Part 3

## 3.1

Перевод

    8 Mbps = 1 MB/s
    100 MB/s = 819200 Kbps
    1 Gbps = 1024 Mbps

## 3.2

Описание iperf3

+ ```iperf3``` — это инструмент для измерения пропускной способности сети. Он может тестировать TCP или пропускная способность UDP. Для выполнения теста iperf3 пользователь должен установить как сервер, так и клиент.

Использование:
```iperf3 -s [ options ]```
```iperf3 -c server [ options ]```

![alt text](../src/png/16.png)

# Part 4

## 4.1 iptables

Скрин с содержанием файла `etc/firewall` для каждой машины

![alt text](../src/png/17.png)

запуск скрипта и его вывод

![alt text](../src/png/18.png)

+ Разница между стратегиями заключается в том, что в первом файле первым подходящим правилом для пакета является запрет, а во втором - разрешение. Применяется только первое подходящее правило, остальные игнорируются.

## 4.2 nmap

обе машины пингуются

![alt text](../src/png/19.png)

# Part 5

## 5.1. Настройка адресов машин
 настрйка файла netpaln согласно рисунку

```ws11```
![alt text](png/20.png)

```r1```
![alt text](png/21.png)

```r2```
![alt text](png/22.png)

```ws22```
![alt text](png/23.1.png)

```ws21```
![alt text](png/24.png)


`Перезапускаем сервис сети. Если ошибок нет, то командой ip -4 a проверяем, что адрес машины задан верно. По тоже аналонии пингуем ws22 с ws21 и r1 с ws11.`

![alt text](png/25.png)
`r1`
![alt text](png/26.png)
`r2`
![alt text](png/27.png)
`ws22`
![alt text](png/28.png)
`ws21 c пингом`
![alt text](png/29.1.png)





## 5.2. Включение переадресации IP-адресов.

Для включения переадресации, на роутерах: sysctl -w net.ipv4.ip_forward=1

 `sudo sysctl -w net.ipv4.ip_forward=1` - команда работает 1 сеанс

`r1`
![alt text](png/30.1.png)

`r2`
![alt text](png/31.png)


* `пишем vim /etc/sysctl.conf** и добавляем в него следующую строку: net.ipv4.ip_forward = 1`

`r1`
![alt text](png/32.png)

`r2`
![alt text](png/33.png)

## 5.3. Установка маршрута по-умолчанию

файлы конфигурации /etc/netplan/* для статических шлюзов по умолчанию

`ws11`
![alt text](png/34.png)

`ws21`
![alt text](png/37.png)

`ws22`
![alt text](png/38.png)

`r1`
![alt text](png/36.png)

`r2`
![alt text](png/35.png)

* Вызываем ip r и показываем, что добавился маршрут в таблицу маршрутизации

`ws11`
![alt text](png/43.png)

`ws21`
![alt text](png/40.png)

`ws22`
![alt text](png/39.png)

`r1`
![alt text](png/41.png)

`r2`
![alt text](png/42.png)

* Пингуем с ws11 роутер r2 и показываем на r2, что пинг доходит. Для этого используем команду:

           sudo tcpdump -tn -i enp0s9

`ws11`
![alt text](png/44.1.png)

`r1`
![alt text](png/45.1.png)

## 5.4. Добавление статических маршрутов

* добавляем в роутеры r1 и r2 статические маршруты в файле конфигураций.

скрины с выводом ip r 

`r1`
![alt text](png/46.png)
![alt text](png/48.png)

`r2`
![alt text](png/47.png)
![alt text](png/49.png)

прыгаем обратно на ws11 и вводим эти команды

    ip r list 10.10.0.0/18 и ip r list 0.0.0.0/0

![alt text](png/50.png)

 * Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, потому что маршрут по умолчанию имеет более низкий приоритет, а для сети 10.10.0.0 мы создали правило, соответственно используется созданный маршрут.

## 5.5. Построение списка маршрутизаторов


запускаем команду дампа на r1

     tcpdump -tnv -i enp0s9

![alt text](png/51.png)


* При помощи утилиты traceroute построить список маршрутизаторов на пути от ws11 до ws21
* Сперва скачиваем утилиту traceroute: sudo apt install trace route, для этого временно изменяем файл конфигураций, для доступа к внешней сети интернет

![alt text](png/52.png)

Traceroute (или трассировка маршрута) - это утилита командной строки, доступная в большинстве операционных системах, включая Linux. Она используется для определения маршрута, который сетевой пакет пройдет от исходного узла до конечного пункта (хоста). Таким образом, traceroute помогает выявить промежуточные узлы (маршрутизаторы), через которые проходит пакет, а также определить время, затраченное на прохождение каждого узла.

Принцип работы traceroute на Linux:

Определение TTL (Time to Live): Когда пакет отправляется через сеть, устанавливается значение TTL, которое представляет собой количество промежуточных узлов (маршрутизаторов), которые пакет может проходить, прежде чем будет удален из сети. Исходно TTL устанавливается на 1.

Отправка пакетов с увеличивающимся TTL: Traceroute отправляет серию пакетов с постепенно увеличивающимся значением TTL. Например, первый пакет отправляется с TTL=1, следующий с TTL=2 и так далее. Это позволяет определить промежуточные узлы, исходя из того, где пакеты прекращают своё движение.

Получение ответов от узлов: Каждый промежуточный узел, через который проходят пакеты, уменьшает значение TTL на 1. Когда значение TTL достигает нуля, узел, через который прошел пакет, удаляет его из сети и отправляет обратно уведомление (ICMP-сообщение) об этом отправителю traceroute.

Отображение информации: Traceroute выводит информацию о каждом промежуточном узле, такую как IP-адрес, имя хоста (если доступно) и время, затраченное на прохождение пакета до узла. Таким образом, traceroute строит маршрут от исходного узла до конечного пункта.

Примечание:

Если пакет доходит до конечного пункта, то он также может получить ответ от этого пункта, что также будет отображено в выводе traceroute. В случае, если узел на пути отключен для передачи ICMP-сообщений (например, из-за настроек безопасности или брандмауэра), traceroute может показать символ "*" для этого узла.

## 5.6. Использование протокола ICMP при маршрутизации

Запускаем на r1 перехват сетевого трафика, проходящего через enp0s8 с помощью команды:

    tcpdump -n -i enp0s8 icmp

![alt text](png/53.png)


Пингуем с ws11 несуществующий IP (например, 10.111.0.1) с помощью команды:

    ping -c5 10.111.0.1

![alt text](png/54.png)

# Part 6

для начала скачаем `isc-dhcp-server` командой `sudo apt install isc-dhcp-server`

Для r2 настрой в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:

`r2`: sudo nano /etc/dhcp/dhcpd.conf, sudo nano /etc/resolv.conf

![alt text](png/55.png)

В файле resolv.conf пропиши nameserver 8.8.8.8 и перезагрузим службу DHCP командой systemctl restart isc-dhcp-server

    sudo apt-get update, sudo apt-get install isc-dhcp-server

`r2`

    sudo systemctl restart isc-dhcp-server


![alt text](png/56.png)

Машину ws21 перезагрузим при помощи reboot и через ip a покажим, что она получила адрес. Также пропингуем ws22 с ws21.

* `ws21`

        sudo reboot, ip a, ping -c 4 10.20.0.2

* ip адрес получен enp0s8: 10.20.0.20/25

![alt text](png/58.png)

![alt text](png/57.png)

* Указать MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: macaddress: 10:10:10:10:10:BA, dhcp4: true

![alt text](png/59.png)

Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты
* Снова скачиваем isc-dhcp-server и вносим изменения в файл /etc/dhcp/dhcpd.conf

![alt text](png/60.png)

* затем редактируем файл /etc/resolv.conf

![alt text](png/61.png)

* перезагружаем службу DHCP

        sudo systemctl restart isc-dhcp-server

* вызываем команду `sudo dhclient enp0s8 -r`, потом `sudo dhclient enp0s8` и снова `ip a`

![alt text](png/62.png)

* в данном пункте пользовался опцией -r для того, чтобы очистить список ip адресов. Видим изменение ip адреса на интерфейсе enp0s8.

В данном пункте использованы следующие опции DHCP сервера:

* subnet - указывает подсеть, для которой настраивается DHCP-сервер
* netmask - указывает маску подсети для соответствующей подсети.
* range - указывает диапазон IP-адресов, которые будут выдаваться DHCP-сервером клиентам в соответствующей подсети.
* option routers - указывает IP-адрес шлюза по умолчанию для клиентов в соответствующей подсети.
* option domain-name-servers - указывает IP-адрес DNS-сервера для клиентов в соответствующей подсети.
* host - указывает конфигурацию для конкретного клиента, определяемого по MAC-адресу сетевого интерфейса.
* hardware ethernet - указывает MAC-адрес сетевого интерфейса клиента.
* fixed-address - указывает IP-адрес, который будет назначен конкретному клиенту.


# Part 7

Поправим файлы netplan'a для того чтоб скачать утилиту
* ws22, r1: `sudo apt install apache2`

В файле /etc/apache2/ports.conf на ws22 и r1 изменим строку Listen 80 на Listen 0.0.0.0:80

Запустим веб-сервер Apache командой `service apache2 start` на ws22 и r1.

`r1`
![alt text](png/64.png)

`ws22`
![alt text](png/65.png)

Добавь в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:

`r2`
![alt text](png/66.png)

Проверь соединение между ws22 и r1 командой `ping`

![alt text](png/67.png)
![alt text](png/68.png)

При запуске файла с этими правилами, ws22 не должна пинговаться с r1.

Разрешить маршрутизацию всех пакетов протокола ICMP и пингануть ws22 and r1
![alt text](png/69.png)

При запуске файла с этими правилами, ws22 должна пинговаться с r1.

`r1`
![alt text](png/70.png)

`ws22`
![alt text](png/71.png)

* включаем SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)
* включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети

![alt text](png/72.1.png)

Проверить соединение по TCP для SNAT, для этого с ws22 подключиться к серверу Apache на r1 командой:
`sudo telnet [ip][port]`

`ws22`
![alt text](png/73.png)

`r1`
![alt text](png/74.png)


# Part 8

Запустить на r2 фаервол с правилами из Части 7

Запустить веб-сервер Apache на ws22 только на localhost (то есть в файле /etc/apache2/ports.conf изменить строку Listen 80 на Listen localhost:80)

![alt text](png/75.png)

запустить apatche2 на ws22

![alt text](png/76.png)

Воспользоваться Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21

Создаём соединение. Получаем доступ к ws22 с ws21

Вывод команды `ssh -L 8080:127.0.0.1:80 10.20.0.10`

`ws21`
![alt text](png/77.png)


Проверка при помощи `telnet 127.0.0.1 [port]`

![alt text](png/80.png)

проверка по telnet у меня не работает, видно, что машины пингуются, выше видно окно вывода подключния к машине(причем проверка по telnet работает в обратном наравлении с ws22 to ws21)

`ws22` 
ssh -R 8080:127.0.0.1:80 10.20.0.2  
![alt text](png/79.png)

далее у меня все полетело и не работает, тут я остановился
